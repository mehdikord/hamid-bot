# ربات تلگرام مدیریت CRM (Aiogram 3 - فارسی)

این ربات تلگرام با استفاده از Aiogram 3.x برای مدیریت داخلی تیم فروش ساخته شده است. ربات مدیران و فروشندگان را به هم متصل می‌کند و بر اساس معماری مبتنی بر کامپوننت طراحی شده است.

## ویژگی‌های اصلی

- **ارجاع مشتری**: مدیران می‌توانند مشتریان جدید را به فروشندگان ارجاع دهند
- **ثبت فعالیت**: فروشندگان می‌توانند تماس‌ها، پیگیری‌ها و سایر فعالیت‌ها را ثبت کنند
- **یادآورها**: ثبت یادآورهای شخصی برای مدیران و فروشندگان
- **گزارش‌گیری**: گزارش‌های روزانه خودکار
- **کشف موضوعات گروه**: کشف خودکار موضوعات (Topics) در گروه‌های تلگرام
- **API Webhook**: ارسال اعلان‌ها و رسیدها از طریق API خارجی
- **رابط کاربری فارسی**: تمام متن‌ها و دکمه‌ها به زبان فارسی

## نصب و راه‌اندازی

### 1. نیازمندی‌ها
```bash
pip install -r requirements.txt
```

### 2. پیکربندی

#### الف) کپی کردن فایل تنظیمات:
```bash
cp config_template.py config.py
```

#### ب) دریافت API credentials از Telegram
برای استفاده از قابلیت کشف موضوعات، نیاز به API credentials دارید:

1. به [my.telegram.org](https://my.telegram.org) بروید
2. وارد حساب کاربری خود شوید
3. به بخش "API development tools" بروید
4. یک اپلیکیشن جدید ایجاد کنید
5. `API_ID` و `API_HASH` را کپی کنید

#### ج) ویرایش فایل config.py
فایل `config.py` را با اطلاعات خود ویرایش کنید:

```python
# توکن ربات از BotFather
BOT_TOKEN = "YOUR_BOT_TOKEN"

# API credentials برای کشف موضوعات (از my.telegram.org)
API_ID = 12345678  # API ID از my.telegram.org
API_HASH = "your_api_hash_here"  # API Hash از my.telegram.org

# شناسه‌های تلگرام مدیران و فروشندگان
MANAGER_IDS = [123456789]  # شناسه تلگرام مدیران
SELLER_IDS = [987654321]   # شناسه تلگرام فروشندگان

# نام‌های نمایشی (اختیاری)
USER_NAMES = {
    123456789: "علی مدیر",
    987654321: "رضا فروشنده"
}

# شناسه گروه برای گزارش‌های تیمی
GROUP_CHAT_ID = -1001234567890
```

#### د) نحوه دریافت شناسه‌های تلگرام
- **شناسه کاربر**: به @userinfobot پیام دهید
- **شناسه گروه**: @userinfobot را به گروه اضافه کنید و /start بزنید

### 3. راه‌اندازی احراز هویت کاربر (برای کشف موضوعات)

برای استفاده از قابلیت کشف موضوعات گروه، ابتدا باید با حساب کاربری شخصی خود احراز هویت کنید:

```bash
python setup_user_auth.py
```

**نکات مهم:**
- از حساب کاربری **شخصی** خود استفاده کنید (نه حساب ربات)
- شماره تلفن و کد تأیید را وارد کنید
- این فرآیند فقط یک بار انجام می‌شود
- فایل `topic_discovery_session.session` ایجاد می‌شود

### 4. اجرای ربات

#### اجرای عادی (برای تست):
```bash
python main.py
```

#### اجرای به عنوان سرویس (برای محیط تولید):
```bash
# اجرای در پس‌زمینه با nohup
nohup /root/hamid-bot-main/venv/bin/python main.py > bot.log 2>&1 &

# بررسی وضعیت سرویس
ps aux | grep main.py
```

#### مدیریت سرویس:
```bash
# متوقف کردن سرویس
pkill -f "python main.py"

# یا با PID مشخص
kill <PID>

# بررسی لاگ‌ها
tail -f bot.log
```

#### اجرای با systemd (پیشنهادی برای سرور):
```bash
# کپی کردن فایل سرویس
sudo cp hamid-bot.service /etc/systemd/system/

# بارگذاری مجدد systemd
sudo systemctl daemon-reload

# فعال‌سازی سرویس
sudo systemctl enable hamid-bot

# شروع سرویس
sudo systemctl start hamid-bot

# بررسی وضعیت
sudo systemctl status hamid-bot

# مشاهده لاگ‌ها
sudo journalctl -u hamid-bot -f

# متوقف کردن سرویس
sudo systemctl stop hamid-bot

# راه‌اندازی مجدد سرویس
sudo systemctl restart hamid-bot
```

## نحوه استفاده

### برای مدیران:
1. **📌 ارجاع مشتری**: مشتری جدید به فروشنده ارجاع دهید
2. **💰 ثبت پرداخت**: پرداخت دریافتی را ثبت کنید
3. **🔔 ثبت یادآور**: یادآور شخصی تنظیم کنید
4. **📊 گزارش‌ها**: گزارش روزانه تیم را مشاهده کنید

### برای فروشندگان:
1. **دریافت ارجاع**: پیام‌های ارجاع مشتری از مدیر دریافت کنید
2. **ثبت فعالیت**: 
   - 📞 ثبت تماس
   - 🔔 ثبت پیگیری  
   - ✅ تغییر وضعیت
   - 📝 افزودن یادداشت
3. **🔔 ثبت یادآور**: یادآور شخصی تنظیم کنید

## کشف موضوعات گروه

ربات قابلیت کشف خودکار موضوعات (Topics) در گروه‌های تلگرام را دارد:

### ویژگی‌های کشف موضوعات:
- **کشف خودکار**: تشخیص موضوعات فعال در گروه
- **نام‌های واقعی**: دریافت نام‌های واقعی موضوعات (نه فقط ID)
- **تشخیص نوع گروه**: تشخیص خودکار اینکه گروه از موضوعات پشتیبانی می‌کند یا نه
- **پشتیبانی از انواع گروه**: گروه‌های معمولی، سوپرگروه‌ها و کانال‌ها

### نحوه کار:
1. ربات با استفاده از `setup_user_auth.py` با حساب کاربری شخصی احراز هویت می‌کند
2. هنگام درخواست کشف موضوعات، ربات به گروه دسترسی پیدا می‌کند
3. موضوعات فعال را شناسایی و نام‌های واقعی آن‌ها را استخراج می‌کند
4. نتیجه شامل ID موضوع، نام واقعی و وضعیت آن است

### مثال خروجی:
```json
{
  "topics": [
    {
      "topic_id": 1,
      "name": "عمومی",
      "status": "active"
    },
    {
      "topic_id": 12345,
      "name": "فروش",
      "status": "active"
    },
    {
      "topic_id": 12346,
      "name": "پشتیبانی",
      "status": "active"
    }
  ]
}
```

## API Webhook

ربات دارای یک API Webhook برای ارسال اعلان‌ها و رسیدها است:

### آدرس API
```
http://localhost:8000
```

### ارسال اعلان ساده
```bash
curl -X POST "http://localhost:8000/send-notification" \
  -H "Content-Type: application/json" \
  -d '{
    "chat_id": 123456789,
    "message": "سلام! این یک اعلان تست است.",
    "parse_mode": "HTML"
  }'
```

### ارسال اعلان با دکمه
```bash
curl -X POST "http://localhost:8000/send-notification-with-buttons" \
  -H "Content-Type: application/json" \
  -d '{
    "chat_id": 123456789,
    "message": "لطفاً عملیات مورد نظر را انتخاب کنید:",
    "buttons": [
      [{"text": "تأیید", "callback_data": "confirm"}],
      [{"text": "لغو", "callback_data": "cancel"}]
    ]
  }'
```

### کشف موضوعات گروه
```bash
curl -X POST "http://localhost:8000/discover-group-topics" \
  -H "Content-Type: application/json" \
  -d '{
    "group_id": -1001234567890
  }'
```

## ساختار پروژه

```
project_root/
├── main.py                    # نقطه ورود ربات و API
├── config.py                  # تنظیمات ربات
├── config_template.py         # الگوی تنظیمات
├── setup_user_auth.py         # راه‌اندازی احراز هویت کاربر
├── requirements.txt           # وابستگی‌ها
├── handlers/                  # کنترل‌کننده‌های ربات
│   ├── common.py             # دستورات عمومی
│   ├── auth.py               # احراز هویت
│   ├── seller_main.py        # داشبورد فروشنده
│   └── reports.py            # گزارش‌گیری
├── keyboards/                # صفحه‌کلیدهای داخلی
│   ├── main_menu.py          # منوی اصلی
│   └── navigation.py         # ناوبری
├── middleware/               # میان‌افزارها
│   └── auth_middleware.py    # میان‌افزار احراز هویت
├── utils/                    # ابزارهای کمکی
│   └── telegram_helpers.py   # کمک‌کننده‌های تلگرام
├── topic_discovery_session.session  # فایل جلسه کاربر
└── hamid-bot.service         # فایل سرویس systemd
```

## نکات فنی

- **Aiogram 3.x**: استفاده از آخرین نسخه Aiogram
- **FastAPI**: API Webhook با FastAPI و Uvicorn
- **Telethon**: کشف موضوعات گروه با Telethon
- **احراز هویت کاربر**: استفاده از حساب کاربری شخصی برای دسترسی کامل به API
- **کشف هوشمند موضوعات**: تشخیص خودکار موضوعات فعال در گروه‌ها
- **API خارجی**: مدیریت داده‌ها از طریق API خارجی
- **رابط کاربری فارسی**: تمام متن‌ها و دکمه‌ها به زبان فارسی
- **معماری آسنکرون**: عملکرد بهتر با async/await
- **منطقه زمانی**: آسیا/تهران

## عیب‌یابی

### مشکل کشف موضوعات
اگر کشف موضوعات کار نمی‌کند:

1. **بررسی احراز هویت کاربر**:
   ```bash
   python setup_user_auth.py
   ```

2. **بررسی API credentials**:
   - مطمئن شوید `API_ID` و `API_HASH` در `config.py` صحیح هستند
   - از [my.telegram.org](https://my.telegram.org) credentials جدید دریافت کنید

3. **بررسی دسترسی به گروه**:
   - مطمئن شوید حساب کاربری شخصی شما عضو گروه است
   - مطمئن شوید گروه از موضوعات پشتیبانی می‌کند

4. **حذف فایل جلسه**:
   ```bash
   rm topic_discovery_session.session
   python setup_user_auth.py
   ```

### مشکل API Webhook
اگر API کار نمی‌کند:

1. **بررسی پورت**:
   - مطمئن شوید پورت 8000 آزاد است
   - پورت را در `main.py` تغییر دهید

2. **بررسی لاگ‌ها**:
   ```bash
   tail -f bot.log
   ```

## نکات امنیتی

- **فایل‌های حساس**: `config.py` و `topic_discovery_session.session` در `.gitignore` قرار دارند
- **دسترسی محدود**: فقط کاربران مجاز (در لیست‌های MANAGER_IDS و SELLER_IDS) می‌توانند از ربات استفاده کنند
- **API credentials**: API_ID و API_HASH را محرمانه نگه دارید
- **فایل جلسه**: فایل `topic_discovery_session.session` را محرمانه نگه دارید
- **توکن ربات**: توکن ربات و شناسه‌های کاربران را محرمانه نگه دارید
- **محیط تولید**: برای محیط تولید، از webhook به جای polling استفاده کنید

## فایل‌های نادیده گرفته شده (.gitignore)

```
config.py
topic_discovery_session.session
*.log
.env
__pycache__/
*.pyc
venv/
```

## پشتیبانی

برای گزارش مشکلات یا درخواست ویژگی‌های جدید، لطفاً issue ایجاد کنید.

## مجوز

این پروژه تحت مجوز MIT منتشر شده است.
